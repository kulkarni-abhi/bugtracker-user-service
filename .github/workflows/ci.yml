name: CI Pipeline

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io/kulkarni-abhi

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
      # -------------------------------
      # Checkout Service Repo
      # -------------------------------
      - name: Checkout Service Repo
        uses: actions/checkout@v4

      # -------------------------------
      # Set Variables
      # -------------------------------
      - name: Set Variables
        id: vars
        run: |
          BRANCH=${GITHUB_REF##*/}
          FULL_SERVICE=${{ github.event.repository.name }}

          # Remove bugtracker- prefix
          SERVICE=${FULL_SERVICE#bugtracker-}

          if [[ "$BRANCH" == "dev" ]]; then
            TAG="dev-${GITHUB_SHA}"
          elif [[ "$BRANCH" == "main" ]]; then
            TAG="release-${GITHUB_SHA}"
          else
            TAG="feature-${GITHUB_SHA}"
          fi

          echo "BRANCH_NAME=$BRANCH" >> $GITHUB_OUTPUT
          echo "SERVICE_NAME=$SERVICE" >> $GITHUB_OUTPUT
          echo "FULL_SERVICE_NAME=$FULL_SERVICE" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT

      # -------------------------------
      # Login to GHCR
      # -------------------------------
      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # -------------------------------
      # Build Image
      # -------------------------------
      - name: Build Image
        run: |
          docker build -t $REGISTRY/${{ steps.vars.outputs.FULL_SERVICE_NAME }}:${{ steps.vars.outputs.TAG }} .

      # -------------------------------
      # Push Image
      # -------------------------------
      - name: Push Image
        run: |
          docker push $REGISTRY/${{ steps.vars.outputs.FULL_SERVICE_NAME }}:${{ steps.vars.outputs.TAG }}

      # --------------------------------------------------
      # Update GitOps Repo (Only dev & main)
      # --------------------------------------------------
      - name: Update GitOps Repo
        if: steps.vars.outputs.BRANCH_NAME == 'dev' || steps.vars.outputs.BRANCH_NAME == 'main'
        run: |
          echo "Cloning GitOps repository..."

          git clone https://x-access-token:${{ secrets.GITOPS_TOKEN }}@github.com/kulkarni-abhi/bugtracker-gitops.git
          cd bugtracker-gitops

          SERVICE=${{ steps.vars.outputs.SERVICE_NAME }}
          IMAGE_TAG=${{ steps.vars.outputs.TAG }}
          BRANCH=${{ steps.vars.outputs.BRANCH_NAME }}

          echo "Updating service: $SERVICE"
          echo "Image tag: $IMAGE_TAG"
          echo "Branch: $BRANCH"

          # Update correct environments
          if [[ "$BRANCH" == "dev" ]]; then
            sed -i "s/tag:.*/tag: \"${IMAGE_TAG}\"/" environments/dev/${SERVICE}-values.yaml
            sed -i "s/tag:.*/tag: \"${IMAGE_TAG}\"/" environments/qe/${SERVICE}-values.yaml
          fi

          if [[ "$BRANCH" == "main" ]]; then
            sed -i "s/tag:.*/tag: \"${IMAGE_TAG}\"/" environments/staging/${SERVICE}-values.yaml
            sed -i "s/tag:.*/tag: \"${IMAGE_TAG}\"/" environments/prod/${SERVICE}-values.yaml
          fi

          git config user.name "ci-bot"
          git config user.email "ci@bot.com"

          git add .
          git commit -m "Deploy ${SERVICE}:${IMAGE_TAG}" || echo "No changes to commit"

          git push origin main

          echo "GitOps update complete."
